<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debug Dashboard Data</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        pre { background: #000; padding: 10px; border: 1px solid #0f0; }
        .section { margin: 20px 0; border: 2px solid #0f0; padding: 10px; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>üîç DEBUG DASHBOARD DATA</h1>
    <div id="output"></div>
    
    <script type="module">
        import { initDB, getConnection } from '/src/db/duckdb.ts';
        
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            output.appendChild(div);
        }
        
        async function debug() {
            try {
                log('========================================', 'success');
                log('INITIALISATION DUCKDB', 'success');
                log('========================================', 'success');
                
                await initDB();
                log('‚úì DuckDB initialis√©', 'success');
                
                const conn = getConnection();
                log('‚úì Connexion obtenue', 'success');
                
                log('\n========================================', 'success');
                log('STATISTIQUES 2025', 'success');
                log('========================================', 'success');
                
                const stats = await conn.query(`
                    SELECT 
                        COUNT(*) as total_lignes,
                        COUNT(DISTINCT facture) as factures_uniques,
                        COUNT(DISTINCT carte) as clients_uniques,
                        SUM(ca) as ca_total,
                        COUNT(DISTINCT depot) as depots
                    FROM transactions
                    WHERE date >= '2025-01-01' AND date <= '2025-12-31'
                `);
                
                const statsRow = stats.toArray()[0];
                log(`Total lignes:        ${statsRow.total_lignes?.toLocaleString()}`, 'success');
                log(`Factures uniques:    ${statsRow.factures_uniques?.toLocaleString()}`, 'success');
                log(`Clients uniques:     ${statsRow.clients_uniques?.toLocaleString()}`, 'success');
                log(`CA total:            ${statsRow.ca_total?.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨`, 'success');
                log(`D√©p√¥ts:              ${statsRow.depots}`, 'success');
                
                log('\n========================================', 'success');
                log('TOP 5 MAGASINS', 'success');
                log('========================================', 'success');
                
                const magasins = await conn.query(`
                    SELECT 
                        m.nom as magasin,
                        COUNT(DISTINCT t.facture) as nb_factures,
                        SUM(t.ca) as ca_total
                    FROM transactions t
                    LEFT JOIN magasins m ON t.depot = m.code
                    WHERE t.date >= '2025-01-01' AND t.date <= '2025-12-31'
                    GROUP BY m.nom
                    ORDER BY nb_factures DESC
                    LIMIT 5
                `);
                
                const magArray = magasins.toArray();
                for (const mag of magArray) {
                    log(`${mag.magasin || 'NULL'}: ${mag.nb_factures?.toLocaleString()} factures, ${mag.ca_total?.toLocaleString('fr-FR', {minimumFractionDigits: 2})} ‚Ç¨`, 'success');
                }
                
                log('\n========================================', 'success');
                log('√âCHANTILLON DONN√âES (5 premi√®res lignes)', 'success');
                log('========================================', 'success');
                
                const sample = await conn.query(`
                    SELECT 
                        t.facture,
                        t.date,
                        t.ca,
                        m.nom as magasin,
                        p.famille
                    FROM transactions t
                    LEFT JOIN produits p ON t.produit = p.id
                    LEFT JOIN magasins m ON t.depot = m.code
                    WHERE t.date >= '2025-01-01' AND t.date <= '2025-12-31'
                    LIMIT 5
                `);
                
                const sampleArray = sample.toArray();
                for (const row of sampleArray) {
                    log(`Facture ${row.facture} | ${row.date} | ${row.ca?.toFixed(2)}‚Ç¨ | ${row.magasin || 'NULL'} | ${row.famille || 'NULL'}`, 'success');
                }
                
                log('\n========================================', 'success');
                log('‚úì DEBUG TERMIN√â', 'success');
                log('========================================', 'success');
                
            } catch (error) {
                log('\n========================================', 'error');
                log('‚ùå ERREUR', 'error');
                log('========================================', 'error');
                log(error.toString(), 'error');
                log(error.stack, 'error');
            }
        }
        
        debug();
    </script>
</body>
</html>
